extends ../layout/main

block content
  style.
    /* Match Create Form Styles */
    .match-form-page {
      background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
      min-height: 100vh;
      padding: 2rem 0;
    }
    
    /* Header Section */
    .form-header {
      background: linear-gradient(135deg, #1C1C1E 0%, #2c2c2e 100%);
      border-radius: 24px;
      padding: 2rem;
      margin-bottom: 2rem;
      color: white;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      animation: fadeInDown 0.6s ease-out;
    }
    
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .form-header h1 {
      font-family: 'Bebas Neue', cursive;
      font-size: 2.5rem;
      letter-spacing: 1px;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #FF3B30 0%, #FF9500 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .form-header p {
      color: rgba(255, 255, 255, 0.7);
      font-size: 1rem;
      margin: 0;
    }
    
    /* Alerts */
    .alert {
      border-radius: 12px;
      border: none;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      animation: slideInDown 0.4s ease-out;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    @keyframes slideInDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .alert-danger {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #991b1b;
      border-left: 4px solid #dc2626;
    }
    
    .alert-success {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
      border-left: 4px solid #059669;
    }
    
    .alert i {
      font-size: 1.2rem;
    }
    
    /* Form Card */
    .form-card {
      background: white;
      border-radius: 24px;
      border: 2px solid #f0f0f0;
      padding: 2.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Form Sections */
    .form-section {
      margin-bottom: 2.5rem;
      padding-bottom: 2rem;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .form-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .section-title {
      font-family: 'Bebas Neue', cursive;
      font-size: 1.5rem;
      color: #1C1C1E;
      letter-spacing: 0.5px;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .section-title i {
      color: #FF3B30;
      font-size: 1.5rem;
    }
    
    .section-description {
      color: #6c757d;
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
      padding-left: 2rem;
    }
    
    /* Form Elements */
    .form-label {
      color: #1C1C1E;
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .form-label i {
      color: #FF3B30;
      font-size: 1rem;
    }
    
    .form-label .badge {
      background: linear-gradient(135deg, #fff5f5 0%, #ffe8e6 100%);
      color: #FF3B30;
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
      border-radius: 8px;
      font-weight: 600;
      border: 1px solid #ffeded;
    }
    
    .form-control,
    .form-select {
      border: 2px solid #e8e8e8;
      border-radius: 12px;
      padding: 0.9rem 1.2rem;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background: #f8f9fa;
    }
    
    .form-control:focus,
    .form-select:focus {
      border-color: #FF3B30;
      box-shadow: 0 0 0 0.25rem rgba(255, 59, 48, 0.15);
      background: white;
    }
    
    .form-control:hover,
    .form-select:hover {
      border-color: #d0d0d0;
      background: white;
    }
    
    .form-control::placeholder {
      color: #adb5bd;
      font-style: italic;
    }
    
    /* Required Indicator */
    .required-indicator {
      color: #FF3B30;
      font-weight: 700;
      margin-left: 0.25rem;
    }
    
    /* Input Icons */
    .input-group-icon {
      position: relative;
    }
    
    .input-group-icon i {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
      font-size: 1.1rem;
      z-index: 10;
    }
    
    .input-group-icon .form-control {
      padding-left: 3rem;
    }
    
    /* Action Buttons */
    .form-actions {
      display: flex;
      gap: 1rem;
      padding-top: 2rem;
      border-top: 2px solid #f0f0f0;
      margin-top: 2rem;
    }
    
    .btn-submit {
      background: linear-gradient(135deg, #FF3B30 0%, #FF9500 100%);
      border: none;
      color: white;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 59, 48, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
      justify-content: center;
    }
    
    .btn-submit:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(255, 59, 48, 0.4);
      color: white;
    }
    
    .btn-submit:active {
      transform: translateY(-1px);
    }
    
    .btn-back {
      background: white;
      border: 2px solid #e8e8e8;
      color: #6c757d;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      justify-content: center;
    }
    
    .btn-back:hover {
      background: #f8f9fa;
      border-color: #1C1C1E;
      color: #1C1C1E;
      transform: translateY(-2px);
    }
    
    /* Help Text */
    .form-text {
      color: #6c757d;
      font-size: 0.85rem;
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    
    .form-text i {
      color: #FF3B30;
      font-size: 0.9rem;
    }
    
    /* Responsive */
    @media (max-width: 991px) {
      .form-header {
        padding: 1.5rem;
      }
      
      .form-header h1 {
        font-size: 2rem;
      }
      
      .form-card {
        padding: 2rem;
      }
    }
    
    @media (max-width: 767px) {
      .match-form-page {
        padding: 1rem 0;
      }
      
      .form-header {
        padding: 1.25rem;
        border-radius: 16px;
      }
      
      .form-header h1 {
        font-size: 1.75rem;
      }
      
      .form-card {
        padding: 1.5rem;
        border-radius: 16px;
      }
      
      .section-title {
        font-size: 1.3rem;
      }
      
      .form-section {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
      }
      
      .form-control,
      .form-select {
        padding: 0.8rem 1rem;
      }
      
      .form-actions {
        flex-direction: column;
      }
      
      .btn-submit,
      .btn-back {
        width: 100%;
      }
    }

  .match-form-page
    .container
      //- Header Section
      .form-header
        h1
          i.bi.bi-plus-circle-fill
          | Tambah Pertandingan
        p
          i.bi.bi-info-circle.me-2
          | Lengkapi form di bawah untuk menambahkan pertandingan baru

      //- Flash Messages
      if flash && flash.error && flash.error.length
        each msg in flash.error
          .alert.alert-danger(role="alert")
            i.bi.bi-exclamation-triangle-fill
            span= msg
      
      if flash && flash.success && flash.success.length
        each msg in flash.success
          .alert.alert-success(role="alert")
            i.bi.bi-check-circle-fill
            span= msg

      //- Form Card
      .form-card
        form(method="post" action="/subadmin/matches/create")
          
          //- Section 1: Basic Info
          .form-section
            .section-title
              i.bi.bi-info-circle-fill
              | Informasi Dasar
            .section-description
              | Pilih cabang olahraga dan venue untuk pertandingan.
            
            .row.g-3
              .col-md-6
                .mb-3
                  label.form-label(for="sport_id")
                    i.bi.bi-trophy
                    | Cabang Olahraga
                    span.required-indicator *
                  select.form-select#sport_id(name="sport_id" required)
                    option(value="" selected disabled) -- Pilih cabang olahraga --
                    if sports && sports.length
                      each s in sports
                        option(value=s.id)= s.name
                  small.form-text
                    i.bi.bi-info-circle
                    | Pilih cabang olahraga yang sesuai
              
              .col-md-6
                .mb-3
                  label.form-label(for="venue_id")
                    i.bi.bi-geo-alt
                    | Venue
                    span.badge Opsional
                  select.form-select#venue_id(name="venue_id")
                    option(value="" selected) -- Pilih venue --
                    if venues && venues.length
                      each v in venues
                        option(value=v.id)= v.name
                  small.form-text
                    i.bi.bi-info-circle
                    | Lokasi pertandingan (boleh kosong)
              
              .col-12
                .mb-3
                  label.form-label(for="event_id")
                    i.bi.bi-calendar-event
                    | Event ID
                    span.badge Opsional
                  input.form-control#event_id(
                    type="number"
                    name="event_id"
                    min="1"
                    placeholder="Masukkan ID event (contoh: 123)"
                  )
                  small.form-text
                    i.bi.bi-info-circle
                    | Jika pertandingan ini bagian dari event tertentu, masukkan ID event-nya

          //- Section 2: Teams
          .form-section
            .section-title
              i.bi.bi-people-fill
              | Tim yang Bertanding
            .section-description
              | Pilih tim rumah dan tim tamu (opsional). Kamu juga bisa tambah tim via tombol +.

            .row.g-3
              .col-md-6
                .mb-3
                  label.form-label(for="home_team_id")
                    i.bi.bi-house-fill
                    | Tim Rumah
                    span.badge Opsional

                  .d-flex.gap-2
                    select.form-select#home_team_id(name="home_team_id")
                      option(value="" selected) -- Pilih tim rumah --
                      if teams && teams.length
                        each t in teams
                          option(value=t.id data-sport=t.sport_id)= t.name

                    button.btn.btn-outline-danger(type="button" id="btnAddTeamHome")
                      i.bi.bi-plus-lg

                  small.form-text
                    i.bi.bi-info-circle
                    | Tim yang bermain di kandang

              .col-md-6
                .mb-3
                  label.form-label(for="away_team_id")
                    i.bi.bi-car-front-fill
                    | Tim Tamu
                    span.badge Opsional

                  .d-flex.gap-2
                    select.form-select#away_team_id(name="away_team_id")
                      option(value="" selected) -- Pilih tim tamu --
                      if teams && teams.length
                        each t in teams
                          option(value=t.id data-sport=t.sport_id)= t.name

                    button.btn.btn-outline-danger(type="button" id="btnAddTeamAway")
                      i.bi.bi-plus-lg

                  small.form-text
                    i.bi.bi-info-circle
                    | Tim yang bermain di tandang

          //- Section 3: Match Details
          .form-section
            .section-title
              i.bi.bi-card-heading
              | Detail Pertandingan
            .section-description
              | Berikan judul dan waktu untuk pertandingan ini.
            
            .mb-3
              label.form-label(for="title")
                i.bi.bi-text-left
                | Judul Pertandingan
                span.required-indicator *
              input.form-control#title(
                type="text"
                name="title"
                required
                placeholder="Contoh: Final Basket Putra - SMKN 8 vs SMAN 1"
              )
              small.form-text
                i.bi.bi-info-circle
                | Buat judul yang jelas dan informatif
            
            .row.g-3
              .col-md-6
                .mb-3
                  label.form-label(for="start_time")
                    i.bi.bi-clock
                    | Waktu Mulai
                    span.required-indicator *
                  input.form-control#start_time(
                    type="datetime-local"
                    name="start_time"
                    required
                  )
                  small.form-text
                    i.bi.bi-info-circle
                    | Kapan pertandingan dimulai
              
              .col-md-6
                .mb-3
                  label.form-label(for="end_time")
                    i.bi.bi-clock-history
                    | Waktu Berakhir
                    span.badge Opsional
                  input.form-control#end_time(
                    type="datetime-local"
                    name="end_time"
                  )
                  small.form-text
                    i.bi.bi-info-circle
                    | Estimasi waktu selesai (boleh kosong)

          //- Action Buttons
          .form-actions
            button.btn.btn-submit(type="submit")
              i.bi.bi-save-fill
              span Simpan Pertandingan
            
            a.btn.btn-back(href="/subadmin/matches")
              i.bi.bi-arrow-left
              span Kembali ke Daftar

    //- Modal Add Team
    .modal.fade#addTeamModal(tabindex="-1" aria-hidden="true")
      .modal-dialog
        .modal-content
          .modal-header
            h5.modal-title Tambah Tim Baru
            button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
          .modal-body
            .mb-3
              label.form-label Cabang Olahraga
              select.form-select#team_sport_id
                option(value="" selected disabled) -- pilih sport --
                if sports && sports.length
                  each s in sports
                    option(value=s.id)= s.name

            .mb-3
              label.form-label Nama Tim
              input.form-control#team_name(type="text" placeholder="Contoh: SMKN 8 Jakarta")

            .mb-3
              label.form-label Short Name (opsional)
              input.form-control#team_short(type="text" placeholder="SMKN8")

            .mb-3
              label.form-label Kota (opsional)
              input.form-control#team_city(type="text" placeholder="Jakarta")

            .alert.alert-danger.d-none#teamErr
            .alert.alert-success.d-none#teamOk

          .modal-footer
            button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Batal
            button.btn.btn-danger(type="button" id="btnSaveTeam") Simpan

  //- Custom JavaScript
  script.
    window.addEventListener('load', function() {
      // Auto dismiss alerts
      var alerts = document.querySelectorAll('.alert');
      alerts.forEach(function(alert) {
        setTimeout(function() {
          alert.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
          alert.style.opacity = '0';
          alert.style.transform = 'translateY(-20px)';
          setTimeout(function() {
            alert.remove();
          }, 500);
        }, 5000);
      });
      
      // Form validation
      var form = document.querySelector('form');
      if (form) {
        form.addEventListener('submit', function(e) {
          var btn = form.querySelector('.btn-submit');
          if (btn) {
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Menyimpan...';
            btn.disabled = true;
          }
        });
      }
      
      // Set minimum datetime to now
      var startTimeInput = document.getElementById('start_time');
      var endTimeInput = document.getElementById('end_time');
      
      if (startTimeInput) {
        var now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        startTimeInput.min = now.toISOString().slice(0, 16);
      }
      
      // Auto set end time based on start time
      if (startTimeInput && endTimeInput) {
        startTimeInput.addEventListener('change', function() {
          if (this.value && !endTimeInput.value) {
            var start = new Date(this.value);
            start.setHours(start.getHours() + 2);
            start.setMinutes(start.getMinutes() - start.getTimezoneOffset());
            endTimeInput.value = start.toISOString().slice(0, 16);
          }
          endTimeInput.min = this.value;
        });
      }
      
      // Validate teams (home and away should be different)
      var homeTeamSelect = document.getElementById('home_team_id');
      var awayTeamSelect = document.getElementById('away_team_id');
      
      if (homeTeamSelect && awayTeamSelect) {
        function validateTeams() {
          var homeValue = homeTeamSelect.value;
          var awayValue = awayTeamSelect.value;
          
          if (homeValue && awayValue && homeValue === awayValue) {
            awayTeamSelect.setCustomValidity('Tim tamu harus berbeda dengan tim rumah');
          } else {
            awayTeamSelect.setCustomValidity('');
          }
        }
        
        homeTeamSelect.addEventListener('change', validateTeams);
        awayTeamSelect.addEventListener('change', validateTeams);
      }
      
      // Character counter for title
      var titleInput = document.getElementById('title');
      if (titleInput) {
        var maxLength = 200;
        var counter = document.createElement('small');
        counter.className = 'form-text text-end d-block mt-1';
        counter.style.color = '#6c757d';
        titleInput.parentNode.appendChild(counter);
        
        function updateCounter() {
          var length = titleInput.value.length;
          counter.textContent = length + ' / ' + maxLength + ' karakter';
          
          if (length > maxLength * 0.9) {
            counter.style.color = '#FF3B30';
          } else {
            counter.style.color = '#6c757d';
          }
        }
        
        titleInput.maxLength = maxLength;
        titleInput.addEventListener('input', updateCounter);
        updateCounter();
      }
      
      // ===== Add Team Modal Logic =====
      // Wait for DOM to be fully loaded
      var addTeamModalEl = document.getElementById('addTeamModal');
      var addTeamModal = null;
      
      console.log('addTeamModalEl:', addTeamModalEl);
      console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
      
      // Check if Bootstrap is loaded and element exists
      if (typeof bootstrap !== 'undefined') {
        if (addTeamModalEl) {
          try {
            addTeamModal = new bootstrap.Modal(addTeamModalEl);
            console.log('Bootstrap Modal initialized successfully');
          } catch (err) {
            console.error('Error initializing modal:', err);
          }
        } else {
          console.error('Modal element #addTeamModal not found in DOM');
        }
      } else {
        console.error('Bootstrap not loaded');
      }

      var btnAddHome = document.getElementById('btnAddTeamHome');
      var btnAddAway = document.getElementById('btnAddTeamAway');

      console.log('btnAddHome:', btnAddHome);
      console.log('btnAddAway:', btnAddAway);

      var sportSelectMain = document.getElementById('sport_id');
      var teamSport = document.getElementById('team_sport_id');

      var homeSelect = document.getElementById('home_team_id');
      var awaySelect = document.getElementById('away_team_id');

      var saveBtn = document.getElementById('btnSaveTeam');
      var errBox = document.getElementById('teamErr');
      var okBox = document.getElementById('teamOk');

      var activeTarget = 'home';

      function showTeamError(msg) {
        if (!errBox) return;
        errBox.textContent = msg;
        errBox.classList.remove('d-none');
        if (okBox) okBox.classList.add('d-none');
      }

      function showTeamOk(msg) {
        if (!okBox) return;
        okBox.textContent = msg;
        okBox.classList.remove('d-none');
        if (errBox) errBox.classList.add('d-none');
      }

      function openAddTeam(target) {
        console.log('openAddTeam called with target:', target);
        activeTarget = target;
        if (errBox) errBox.classList.add('d-none');
        if (okBox) okBox.classList.add('d-none');

        if (sportSelectMain && teamSport) {
          teamSport.value = sportSelectMain.value || '';
        }
        
        if (addTeamModal) {
          addTeamModal.show();
          console.log('Modal should be showing now');
        } else {
          console.error('Modal not initialized');
        }
      }

      if (btnAddHome) {
        btnAddHome.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Home button clicked');
          openAddTeam('home');
        });
        console.log('Home button listener attached');
      } else {
        console.error('btnAddHome not found');
      }
      
      if (btnAddAway) {
        btnAddAway.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Away button clicked');
          openAddTeam('away');
        });
        console.log('Away button listener attached');
      } else {
        console.error('btnAddAway not found');
      }

      if (saveBtn) {
        saveBtn.addEventListener('click', async function() {
          var sport_id = teamSport ? teamSport.value : '';
          var name = document.getElementById('team_name') ? document.getElementById('team_name').value : '';
          var short_name = document.getElementById('team_short') ? document.getElementById('team_short').value : '';
          var city = document.getElementById('team_city') ? document.getElementById('team_city').value : '';

          name = name.trim();
          if (!sport_id) return showTeamError('Pilih cabang olahraga dulu.');
          if (!name) return showTeamError('Nama tim wajib diisi.');

          saveBtn.disabled = true;
          saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Menyimpan...';

          try {
            const resp = await fetch('/subadmin/teams/ajax-create', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ sport_id, name, short_name, city })
            });

            const data = await resp.json().catch(() => ({}));
            if (!resp.ok || !data.ok) {
              return showTeamError(data.message || 'Gagal menambahkan tim.');
            }

            var opt = document.createElement('option');
            opt.value = data.team.id;
            opt.textContent = data.team.name;
            opt.setAttribute('data-sport', String(data.team.sport_id));

            var targetSelect = activeTarget === 'away' ? awaySelect : homeSelect;
            if (targetSelect) {
              targetSelect.appendChild(opt.cloneNode(true));
              targetSelect.value = String(data.team.id);
            }

            var otherSelect = activeTarget === 'away' ? homeSelect : awaySelect;
            if (otherSelect) {
              otherSelect.appendChild(opt.cloneNode(true));
            }

            showTeamOk('Tim berhasil ditambahkan.');
            setTimeout(function() {
              if (addTeamModal) addTeamModal.hide();
            }, 600);

            document.getElementById('team_name').value = '';
            document.getElementById('team_short').value = '';
            document.getElementById('team_city').value = '';

          } catch (e) {
            console.error(e);
            showTeamError('Server error. Coba lagi.');
          } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'Simpan';
          }
        });
      }
    });