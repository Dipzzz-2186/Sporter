extends ../layout/main

block content
  style.
    /* Match Create Form Styles */
    .match-form-page {
      background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
      min-height: 100vh;
      padding: 2rem 0;
    }
    
    /* Header Section */
    .form-header {
      background: linear-gradient(135deg, #0B1F3F 0%, #152844 100%);
      border-radius: 24px;
      padding: 2rem;
      margin-bottom: 2rem;
      color: white;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      animation: fadeInDown 0.6s ease-out;
    }
    
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .form-header h1 {
      font-family: 'Bebas Neue', cursive;
      font-size: 2.5rem;
      letter-spacing: 1px;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #0095FF 0%, #34C7FF 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .form-header p {
      color: rgba(255, 255, 255, 0.7);
      font-size: 1rem;
      margin: 0;
    }
    
    /* Alerts */
    .alert {
      border-radius: 12px;
      border: none;
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      animation: slideInDown 0.4s ease-out;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    @keyframes slideInDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .alert-danger {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #991b1b;
      border-left: 4px solid #dc2626;
    }
    
    .alert-success {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
      border-left: 4px solid #059669;
    }
    
    .alert i {
      font-size: 1.2rem;
    }
    
    /* Form Card */
    .form-card {
      background: white;
      border-radius: 24px;
      border: 2px solid #e8edf2;
      padding: 2.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      animation: fadeInUp 0.6s ease-out;
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Form Sections */
    .form-section {
      margin-bottom: 2.5rem;
      padding-bottom: 2rem;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .form-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    
    .section-title {
      font-family: 'Bebas Neue', cursive;
      font-size: 1.5rem;
      color: #0B1F3F;
      letter-spacing: 0.5px;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .section-title i {
      color: #0095FF;
      font-size: 1.5rem;
    }
    
    .section-description {
      color: #5a6c7d;
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
      padding-left: 2rem;
    }
    
    /* Form Elements */
    .form-label {
      color: #0B1F3F;
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .form-label i {
      color: #0095FF;
      font-size: 1rem;
    }
    
    .form-label .badge {
      background: linear-gradient(135deg, rgba(0,149,255,0.1) 0%, rgba(0,149,255,0.2) 100%);
      color: #0080e0;
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
      border-radius: 8px;
      font-weight: 600;
      border: 1px solid rgba(0,149,255,0.2);
    }
    
    .form-control,
    .form-select {
      border: 2px solid #e8e8e8;
      border-radius: 12px;
      padding: 0.9rem 1.2rem;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      background: #f8f9fa;
    }
    
    .form-control:focus,
    .form-select:focus {
      border-color: #0095FF;
      box-shadow: 0 0 0 0.25rem rgba(0, 149, 255, 0.15);
      background: white;
    }
    
    .form-control:hover,
    .form-select:hover {
      border-color: #d0d0d0;
      background: white;
    }
    
    .form-control::placeholder {
      color: #adb5bd;
      font-style: italic;
    }
    
    /* Required Indicator */
    .required-indicator {
      color: #0095FF;
      font-weight: 700;
      margin-left: 0.25rem;
    }
    
    /* Input Icons */
    .input-group-icon {
      position: relative;
    }
    
    .input-group-icon i {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #5a6c7d;
      font-size: 1.1rem;
      z-index: 10;
    }
    
    .input-group-icon .form-control {
      padding-left: 3rem;
    }
    
    /* Action Buttons */
    .form-actions {
      display: flex;
      gap: 1rem;
      padding-top: 2rem;
      border-top: 2px solid #f0f0f0;
      margin-top: 2rem;
    }
    
    .btn-submit {
      background: linear-gradient(135deg, #0095FF 0%, #34C7FF 100%);
      border: none;
      color: white;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 149, 255, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
      justify-content: center;
    }
    
    .btn-submit:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 149, 255, 0.4);
      color: white;
    }
    
    .btn-submit:active {
      transform: translateY(-1px);
    }
    
    .btn-back {
      background: white;
      border: 2px solid #e8e8e8;
      color: #5a6c7d;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-decoration: none;
      justify-content: center;
    }
    
    .btn-back:hover {
      background: #f8f9fa;
      border-color: #0B1F3F;
      color: #0B1F3F;
      transform: translateY(-2px);
    }
    
    /* Help Text */
    .form-text {
      color: #5a6c7d;
      font-size: 0.85rem;
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    
    .form-text i {
      color: #0095FF;
      font-size: 0.9rem;
    }
    
    /* Modal Styles */
    .modal-content {
      border-radius: 16px;
      border: 2px solid #e8edf2;
    }
    
    .modal-header {
      background: linear-gradient(135deg, #f5f8fa 0%, #e9eef3 100%);
      border-bottom: 2px solid #e8e8e8;
      border-radius: 16px 16px 0 0;
    }
    
    .modal-title {
      color: #0B1F3F;
      font-weight: 700;
    }
    
    .btn-outline-primary {
      border: 2px solid #0095FF;
      color: #0080e0;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .btn-outline-primary:hover {
      background: linear-gradient(135deg, #0095FF 0%, #34C7FF 100%);
      border-color: #0095FF;
      color: white;
      transform: translateY(-2px);
    }
    
    /* Responsive */
    @media (max-width: 991px) {
      .form-header {
        padding: 1.5rem;
      }
      
      .form-header h1 {
        font-size: 2rem;
      }
      
      .form-card {
        padding: 2rem;
      }
    }
    
    @media (max-width: 767px) {
      .match-form-page {
        padding: 1rem 0;
      }
      
      .form-header {
        padding: 1.25rem;
        border-radius: 16px;
      }
      
      .form-header h1 {
        font-size: 1.75rem;
      }
      
      .form-card {
        padding: 1.5rem;
        border-radius: 16px;
      }
      
      .section-title {
        font-size: 1.3rem;
      }
      
      .form-section {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
      }
      
      .form-control,
      .form-select {
        padding: 0.8rem 1rem;
      }
      
      .form-actions {
        flex-direction: column;
      }
      
      .btn-submit,
      .btn-back {
        width: 100%;
      }
    }

  .match-form-page
    .container
      //- Header Section
      .form-header
        h1
          i.bi.bi-plus-circle-fill
          | Tambah Pertandingan
        p
          i.bi.bi-info-circle.me-2
          | Lengkapi form di bawah untuk menambahkan pertandingan baru

      //- Flash Messages
      if flash && flash.error && flash.error.length
        each msg in flash.error
          .alert.alert-danger(role="alert")
            i.bi.bi-exclamation-triangle-fill
            span= msg
      
      if flash && flash.success && flash.success.length
        each msg in flash.success
          .alert.alert-success(role="alert")
            i.bi.bi-check-circle-fill
            span= msg

      //- Form Card
      .form-card
        form(method="post" action="/subadmin/matches/create")
          
          //- Section 1: Basic Info
          .form-section
            .section-title
              i.bi.bi-info-circle-fill
              | Informasi Dasar
            .section-description
              | Pilih cabang olahraga dan venue untuk pertandingan.
            
            .row.g-3
              .col-md-6
                .mb-3
                  label.form-label(for="sport_id")
                    i.bi.bi-trophy
                    | Cabang Olahraga
                    span.required-indicator *
                  select.form-select#sport_id(name="sport_id" required)
                    option(value="" selected disabled) -- Pilih cabang olahraga --
                    if sports && sports.length
                      each s in sports
                        option(value=s.id)= s.name
                  small.form-text
                    i.bi.bi-info-circle
                    | Pilih cabang olahraga yang sesuai
              
              .col-md-6
                .mb-3
                  label.form-label(for="venue_id")
                    i.bi.bi-geo-alt
                    | Venue
                    span.badge Opsional
                  select.form-select#venue_id(name="venue_id")
                    option(value="" selected) -- Pilih venue --
                    if venues && venues.length
                      each v in venues
                        option(value=v.id)= v.name
                  small.form-text
                    i.bi.bi-info-circle
                    | Lokasi pertandingan (boleh kosong)
              
              .col-12
                .mb-3
                  label.form-label(for="event_id")
                    i.bi.bi-calendar-event
                    | Event ID
                    span.badge Opsional
                  input.form-control#event_id(
                    type="number"
                    name="event_id"
                    min="1"
                    placeholder="Masukkan ID event (contoh: 123)"
                  )
                  small.form-text
                    i.bi.bi-info-circle
                    | Jika pertandingan ini bagian dari event tertentu, masukkan ID event-nya

          #afterSportSection(style="display:none;")
            //- MODE MATCH (INDIVIDUAL / TEAM)
            - const currentMode = (match_mode || 'team')

            .mb-3
              label.form-label
                i.bi.bi-sliders
                | Mode Pertandingan
                span.required-indicator *

              .d-flex.gap-3.flex-wrap
                .form-check
                  input.form-check-input(type="radio", name="match_mode", id="modeTeam", value="team", checked=(currentMode==='team'))
                  label.form-check-label(for="modeTeam") Team (2 orang / tim)
                .form-check
                  input.form-check-input(type="radio", name="match_mode", id="modeIndividual", value="individual", checked=(currentMode==='individual'))
                  label.form-check-label(for="modeIndividual") Individual (1 vs 1)

              small.form-text
                i.bi.bi-info-circle
                | Pilih mode sebelum memilih Home/Away.

              //- Team VS Team
              #teamVsContainer
                .row.g-3
                  .col-md-6
                    .mb-3
                      label.form-label(for="home_team_id")
                        i.bi.bi-house-fill
                        | Tim Rumah
                        span.badge Opsional

                      .d-flex.gap-2
                        select.form-select#home_team_id(name="home_team_id")
                          option(value="" selected) -- Pilih tim rumah --
                          if teams && teams.length
                            each t in teams
                              - const ind = (hasIsIndividual ? (Number(t.is_individual) === 1) : false)
                              option(
                                value=t.id
                                data-sport=t.sport_id
                                data-is-individual=(ind ? '1' : '0')
                              )= t.name

                      small.form-text
                        i.bi.bi-info-circle
                        | Tim yang bermain di kandang

                  .col-md-6
                    .mb-3
                      label.form-label(for="away_team_id")
                        i.bi.bi-car-front-fill
                        | Tim Tamu
                        span.badge Opsional

                      .d-flex.gap-2
                        select.form-select#away_team_id(name="away_team_id")
                          option(value="" selected) -- Pilih tim tamu --
                          if teams && teams.length
                            each t in teams
                              - const ind = (hasIsIndividual ? (Number(t.is_individual) === 1) : false)
                              option(
                                value=t.id
                                data-sport=t.sport_id
                                data-is-individual=(ind ? '1' : '0')
                              )= t.name

                      small.form-text
                        i.bi.bi-info-circle
                        | Tim yang bermain di tandang

              //- INDIVIDUAL (MULTI PESERTA)
              #individualContainer(style="display:none;")
                .mb-2.d-flex.gap-2.flex-wrap
                  button.btn.btn-outline-primary(type="button" id="btnAddParticipant")
                    i.bi.bi-plus-lg
                    | Tambah Peserta

                  button.btn.btn-outline-success(type="button" id="btnAddAthlete")
                    i.bi.bi-person-plus
                    | Tambah Pemain Baru

                #participantsList

                small.form-text
                  i.bi.bi-info-circle
                  | Minimal 2 peserta. Bisa sebanyak yang kamu mau.

            //- Section 3: Match Details
            .form-section
              .section-title
                i.bi.bi-card-heading
                | Detail Pertandingan
              .section-description
                | Berikan judul dan waktu untuk pertandingan ini.
              
              .mb-3
                label.form-label(for="title")
                  i.bi.bi-text-left
                  | Judul Pertandingan
                  span.required-indicator *
                input.form-control#title(
                  type="text"
                  name="title"
                  required
                  placeholder="Contoh: Final Basket Putra - SMKN 8 vs SMAN 1"
                )
                small.form-text
                  i.bi.bi-info-circle
                  | Buat judul yang jelas dan informatif
              
              .row.g-3
                .col-md-6
                  .mb-3
                    label.form-label(for="start_time")
                      i.bi.bi-clock
                      | Waktu Mulai
                      span.required-indicator *
                    input.form-control#start_time(
                      type="datetime-local"
                      name="start_time"
                      required
                    )
                    small.form-text
                      i.bi.bi-info-circle
                      | Kapan pertandingan dimulai
                
                .col-md-6
                  .mb-3
                    label.form-label(for="end_time")
                      i.bi.bi-clock-history
                      | Waktu Berakhir
                      span.badge Opsional
                    input.form-control#end_time(
                      type="datetime-local"
                      name="end_time"
                    )
                    small.form-text
                      i.bi.bi-info-circle
                      | Estimasi waktu selesai (boleh kosong)

            //- Section 4: Ticketing
            .form-section
              .section-title
                i.bi.bi-ticket-perforated
                | Penjualan Tiket
              .section-description
                | Atur apakah pertandingan ini menjual tiket atau tidak.

              .mb-3
                label.form-label
                  | Apakah ingin menjual tiket?
                .form-check
                  input.form-check-input(
                    type="radio"
                    name="sell_ticket"
                    id="sellTicketNo"
                    value="0"
                    checked
                  )
                  label.form-check-label(for="sellTicketNo") Tidak
                .form-check
                  input.form-check-input(
                    type="radio"
                    name="sell_ticket"
                    id="sellTicketYes"
                    value="1"
                  )
                  label.form-check-label(for="sellTicketYes") Ya

              //- Ticket Options (hidden by default)
              #ticketOptions(style="display:none;")
                .row.g-3
                  .col-md-4
                    .mb-3
                      label.form-label Tipe Tiket
                      input.form-control(
                        type="text"
                        name="ticket_name"
                        placeholder="Contoh: Regular / VIP"
                      )

                  .col-md-4
                    .mb-3
                      label.form-label Harga per Tiket
                      input.form-control(
                        type="number"
                        name="ticket_price"
                        min="0"
                        step="1000"
                        placeholder="50000"
                      )

                  .col-md-4
                    .mb-3
                      label.form-label Kuota Tiket
                      input.form-control(
                        type="number"
                        name="ticket_quota"
                        min="1"
                        placeholder="100"
                      )

                .mb-3
                  label.form-label Maksimal pembelian per user
                  input.form-control(
                    type="number"
                    name="ticket_max_per_user"
                    min="1"
                    placeholder="2"
                  )

          //- Action Buttons
          .form-actions
            button.btn.btn-submit(type="submit")
              i.bi.bi-save-fill
              span Simpan Pertandingan
            
            a.btn.btn-back(href="javascript:void(0);" onclick="history.back()")
              i.bi.bi-arrow-left
              span Kembali ke Daftar

    //- Modal Add Athlete
    .modal.fade#addAthleteModal(tabindex="-1" aria-hidden="true")
      .modal-dialog
        .modal-content
          .modal-header
            h5.modal-title Tambah Pemain Baru
            button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
          .modal-body
            .mb-3
              label.form-label(for="ath_sport_id") Cabang Olahraga
              select.form-select#ath_sport_id(name="sport_id" required)
                option(value="" selected disabled) -- pilih cabang --
                if sports && sports.length
                  each s in sports
                    option(value=s.id)= s.name

            .mb-3
              label.form-label(for="ath_name") Nama Pemain
              input.form-control#ath_name(type="text" placeholder="Contoh: Budi" required)

            .mb-3
              label.form-label(for="ath_number") Nomor (opsional)
              input.form-control#ath_number(type="text" placeholder="10")

            .mb-3
              label.form-label(for="ath_position") Posisi (opsional)
              input.form-control#ath_position(type="text" placeholder="Striker")

            .alert.alert-danger.d-none#athErr
            .alert.alert-success.d-none#athOk

          .modal-footer
            button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Batal
            button.btn.btn-success(type="button" id="btnSaveAthlete") Simpan

  //- Athletes Data (JSON)
  script(type="application/json" id="athletesData") !{JSON.stringify(athletes || [])}

  //- Main JavaScript
  script.
    (function() {
      'use strict';
      
      console.log('=== MATCH FORM SCRIPT LOADED ===');

      // ========================================
      // GLOBAL VARIABLES & ELEMENT REFERENCES
      // ========================================
      var form = document.querySelector('form');
      var sportSelect = document.getElementById('sport_id');
      var afterSportSection = document.getElementById('afterSportSection');
      
      var modeTeam = document.getElementById('modeTeam');
      var modeInd = document.getElementById('modeIndividual');
      
      var teamVs = document.getElementById('teamVsContainer');
      var individualBox = document.getElementById('individualContainer');
      
      var homeSelect = document.getElementById('home_team_id');
      var awaySelect = document.getElementById('away_team_id');
      
      var participantsList = document.getElementById('participantsList');
      var btnAddParticipant = document.getElementById('btnAddParticipant');
      
      var titleInput = document.getElementById('title');
      var titleTouched = false;
      
      var sellYes = document.getElementById('sellTicketYes');
      var sellNo = document.getElementById('sellTicketNo');
      var ticketBox = document.getElementById('ticketOptions');

      // ========================================
      // INITIALIZE ATHLETES DATA
      // ========================================
      (function initAthletes() {
        var el = document.getElementById('athletesData');
        try {
          window.__ATHLETES__ = el ? JSON.parse(el.textContent || '[]') : [];
          console.log('‚úÖ Athletes loaded:', window.__ATHLETES__.length);
        } catch (e) {
          console.error('‚ùå Failed to parse athletesData:', e);
          window.__ATHLETES__ = [];
        }
      })();

      // ========================================
      // UTILITY FUNCTIONS
      // ========================================
      function escapeHtml(str) {
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function getText(select) {
        if (!select || !select.value) return '';
        return select.options[select.selectedIndex].textContent.trim();
      }

      // ========================================
      // ALERT AUTO DISMISS
      // ========================================
      var alerts = document.querySelectorAll('.alert');
      alerts.forEach(function(alert) {
        setTimeout(function() {
          alert.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
          alert.style.opacity = '0';
          alert.style.transform = 'translateY(-20px)';
          setTimeout(function() {
            alert.remove();
          }, 500);
        }, 5000);
      });

      // ========================================
      // FORM SUBMIT LOADING
      // ========================================
      if (form) {
        form.addEventListener('submit', function(e) {
          // Validate individual mode
          if (modeInd && modeInd.checked) {
            var selected = Array.from(document.querySelectorAll('[name="participant_ids[]"]'))
              .map(function(s) { return s.value; })
              .filter(Boolean);

            if (selected.length < 2) {
              e.preventDefault();
              alert('Mode Individual butuh minimal 2 peserta.');
              return;
            }
          }

          var btn = form.querySelector('.btn-submit');
          if (btn) {
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Menyimpan...';
            btn.disabled = true;
          }
        });
      }

      // ========================================
      // DATETIME INPUT SETUP
      // ========================================
      var startTimeInput = document.getElementById('start_time');
      var endTimeInput = document.getElementById('end_time');
      
      if (startTimeInput) {
        var now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        startTimeInput.min = now.toISOString().slice(0, 16);
      }
      
      if (startTimeInput && endTimeInput) {
        startTimeInput.addEventListener('change', function() {
          if (this.value && !endTimeInput.value) {
            var start = new Date(this.value);
            start.setHours(start.getHours() + 2);
            start.setMinutes(start.getMinutes() - start.getTimezoneOffset());
            endTimeInput.value = start.toISOString().slice(0, 16);
          }
          endTimeInput.min = this.value;
        });
      }

      // ========================================
      // TEAM VALIDATION
      // ========================================
      if (homeSelect && awaySelect) {
        function validateTeams() {
          var homeValue = homeSelect.value;
          var awayValue = awaySelect.value;
          
          if (homeValue && awayValue && homeValue === awayValue) {
            awaySelect.setCustomValidity('Tim tamu harus berbeda dengan tim rumah');
          } else {
            awaySelect.setCustomValidity('');
          }
        }
        
        homeSelect.addEventListener('change', validateTeams);
        awaySelect.addEventListener('change', validateTeams);
      }

      // ========================================
      // TITLE CHARACTER COUNTER
      // ========================================
      if (titleInput) {
        var maxLength = 200;
        var counter = document.createElement('small');
        counter.className = 'form-text text-end d-block mt-1';
        counter.style.color = '#5a6c7d';
        titleInput.parentNode.appendChild(counter);
        
        function updateCounter() {
          var length = titleInput.value.length;
          counter.textContent = length + ' / ' + maxLength + ' karakter';
          
          if (length > maxLength * 0.9) {
            counter.style.color = '#0095FF';
          } else {
            counter.style.color = '#5a6c7d';
          }
        }
        
        titleInput.maxLength = maxLength;
        titleInput.addEventListener('input', function() {
          titleTouched = true;
          updateCounter();
        });
        updateCounter();
      }

      // ========================================
      // SHOW/HIDE AFTER SPORT SECTION
      // ========================================
      function toggleAfterSport() {
        if (sportSelect && sportSelect.value) {
          afterSportSection.style.display = 'block';
        } else {
          afterSportSection.style.display = 'none';
        }
      }

      if (sportSelect) {
        sportSelect.addEventListener('change', function() {
          toggleAfterSport();
          filterTeamsBySport();
          filterTeamsByMode();
        });
      }
      toggleAfterSport();

      // ========================================
      // FILTER TEAMS BY SPORT & MODE
      // ========================================
      function filterTeamsBySport() {
        if (!sportSelect || !sportSelect.value) return;

        var sportId = String(sportSelect.value);

        [homeSelect, awaySelect].forEach(function(sel) {
          if (!sel) return;

          Array.from(sel.options).forEach(function(opt) {
            if (!opt.value) return;

            var optSport = String(opt.getAttribute('data-sport') || '');
            var ok = optSport === sportId;

            opt.hidden = !ok;
            opt.disabled = !ok;
          });

          if (sel.value) {
            var selected = sel.options[sel.selectedIndex];
            if (String(selected.getAttribute('data-sport')) !== sportId) {
              sel.value = '';
            }
          }
        });
      }

      function filterTeamsByMode() {
        if (!sportSelect || !homeSelect || !awaySelect) return;

        var sportId = String(sportSelect.value || '');
        var needIsIndividual = modeInd && modeInd.checked ? '1' : '0';

        [homeSelect, awaySelect].forEach(function(sel) {
          Array.from(sel.options).forEach(function(opt) {
            if (!opt.value) return;

            var optSport = String(opt.getAttribute('data-sport') || '');
            var optInd = opt.getAttribute('data-is-individual');

            var matchSport = optSport === sportId;
            var matchMode = optInd ? optInd === needIsIndividual : true;

            var ok = matchSport && matchMode;

            opt.hidden = !ok;
            opt.disabled = !ok;
          });

          if (sel.value) {
            var selected = sel.options[sel.selectedIndex];
            if (selected.hidden || selected.disabled) {
              sel.value = '';
            }
          }
        });
      }

      // ========================================
      // MODE SWITCHING (TEAM / INDIVIDUAL)
      // ========================================
      function toggleModeUI() {
        if (!modeTeam || !modeInd) return;

        var participantSelects = document.querySelectorAll('[name="participant_ids[]"]');

        if (modeInd.checked) {
          teamVs.style.display = 'none';
          individualBox.style.display = 'block';
          participantSelects.forEach(function(s) { s.required = true; });
          ensureMinParticipants();
        } else {
          teamVs.style.display = 'block';
          individualBox.style.display = 'none';
          participantSelects.forEach(function(s) { s.required = false; });
        }

        filterTeamsByMode();
      }

      if (modeTeam) modeTeam.addEventListener('change', function() {
        toggleModeUI();
        generateTitle();
      });
      
      if (modeInd) modeInd.addEventListener('change', function() {
        toggleModeUI();
        generateTitle();
      });

      toggleModeUI();

      // ========================================
      // PARTICIPANT MANAGEMENT
      // ========================================
      function buildParticipantOptionsHtml() {
        var sportId = String(sportSelect ? sportSelect.value : '');
        if (!sportId) return '';

        var athletes = Array.isArray(window.__ATHLETES__) ? window.__ATHLETES__ : [];

        return athletes
          .filter(function(a) { return String(a.sport_id) === sportId; })
          .filter(function(a) { return String(a.member_type || '').toLowerCase() === 'individual'; })
          .map(function(a) { return '<option value="' + a.id + '">' + escapeHtml(a.name) + '</option>'; })
          .join('');
      }

      function refreshParticipantSelects(keepSelected) {
        if (keepSelected === undefined) keepSelected = true;
        if (!participantsList) return;

        console.log('üîÑ Refreshing participant selects...');
        console.log('   Athletes in cache:', window.__ATHLETES__.length);
        
        var optionsHtml = buildParticipantOptionsHtml();
        console.log('   Generated options HTML length:', optionsHtml.length);
        
        var selects = participantsList.querySelectorAll('select[name="participant_ids[]"]');
        console.log('   Found selects:', selects.length);

        selects.forEach(function(sel, idx) {
          var prev = sel.value;
          sel.innerHTML = '<option value="" selected disabled>-- Pilih peserta --</option>' + optionsHtml;

          console.log('   Select ' + idx + ': options count = ' + sel.options.length);

          if (keepSelected && prev && Array.from(sel.options).some(function(o) { return o.value === prev; })) {
            sel.value = prev;
          } else {
            sel.value = '';
          }
        });
      }

      function createParticipantRow() {
        var row = document.createElement('div');
        row.className = 'd-flex gap-2 align-items-center mb-2 participant-row';

        row.innerHTML =
          '<select class="form-select" name="participant_ids[]" required>' +
          '<option value="" selected disabled>-- Pilih peserta --</option>' +
          buildParticipantOptionsHtml() +
          '</select>' +
          '<button type="button" class="btn btn-outline-danger btnRemoveParticipant">' +
          '<i class="bi bi-x-lg"></i>' +
          '</button>';

        row.querySelector('.btnRemoveParticipant').addEventListener('click', function() {
          row.remove();
        });

        return row;
      }

      function ensureMinParticipants() {
        if (!participantsList) return;
        var rows = participantsList.querySelectorAll('.participant-row');
        while (rows.length < 2) {
          participantsList.appendChild(createParticipantRow());
          rows = participantsList.querySelectorAll('.participant-row');
        }
      }

      if (btnAddParticipant) {
        btnAddParticipant.addEventListener('click', function() {
          participantsList.appendChild(createParticipantRow());
        });
      }

      // Listen for participant select changes
      document.addEventListener('change', function(e) {
        if (e.target.name === 'participant_ids[]') {
          generateTitle();
        }
      });

      // ========================================
      // AUTO TITLE GENERATION
      // ========================================
      function generateTitle() {
        if (titleTouched) return;

        var sportName = getText(sportSelect);
        if (!sportName) return;

        if (modeTeam && modeTeam.checked) {
          var home = getText(homeSelect);
          var away = getText(awaySelect);
          if (home && away) {
            titleInput.value = sportName + ' Tim ' + home + ' vs Tim ' + away;
          }
        }

        if (modeInd && modeInd.checked) {
          var players = Array.from(document.querySelectorAll('[name="participant_ids[]"]'))
            .map(function(s) { return getText(s); })
            .filter(Boolean);

          if (players.length >= 2) {
            titleInput.value = sportName + ' Individu ' + players[0] + ' vs ' + players[1];
          }
        }
      }

      if (sportSelect) sportSelect.addEventListener('change', generateTitle);
      if (homeSelect) homeSelect.addEventListener('change', generateTitle);
      if (awaySelect) awaySelect.addEventListener('change', generateTitle);

      // ========================================
      // TICKET SELLING TOGGLE
      // ========================================
      function toggleTicketBox() {
        if (sellYes && sellYes.checked) {
          ticketBox.style.display = 'block';
        } else {
          ticketBox.style.display = 'none';
        }
      }

      if (sellYes) sellYes.addEventListener('change', toggleTicketBox);
      if (sellNo) sellNo.addEventListener('change', toggleTicketBox);
      toggleTicketBox();

      // ========================================
      // ADD TEAM MODAL
      // ========================================
      
      var teamSport = document.getElementById('team_sport_id');
      var saveTeamBtn = document.getElementById('btnSaveTeam');
      var teamErrBox = document.getElementById('teamErr');
      var teamOkBox = document.getElementById('teamOk');
      var activeTarget = 'home';

      function showTeamError(msg) {
        if (!teamErrBox) return;
        teamErrBox.textContent = msg;
        teamErrBox.classList.remove('d-none');
        if (teamOkBox) teamOkBox.classList.add('d-none');
      }

      function showTeamOk(msg) {
        if (!teamOkBox) return;
        teamOkBox.textContent = msg;
        teamOkBox.classList.remove('d-none');
        if (teamErrBox) teamErrBox.classList.add('d-none');
      }

      // ========================================
      // ADD ATHLETE MODAL
      // ========================================
      var addAthleteModalEl = document.getElementById('addAthleteModal');
      var addAthleteModal = null;

      console.log('üîç Checking athlete modal...');
      console.log('   addAthleteModalEl:', addAthleteModalEl);
      console.log('   Bootstrap available:', typeof bootstrap !== 'undefined');

      if (addAthleteModalEl) {
        if (typeof bootstrap !== 'undefined') {
          try {
            addAthleteModal = new bootstrap.Modal(addAthleteModalEl);
            console.log('‚úÖ Add Athlete Modal initialized');
          } catch (e) {
            console.error('‚ùå Error initializing athlete modal:', e);
          }
        } else {
          console.error('‚ùå Bootstrap not loaded! Modal cannot be initialized.');
          // Fallback: gunakan jQuery jika ada
          if (typeof $ !== 'undefined') {
            console.log('‚ö†Ô∏è Trying jQuery fallback for modal...');
            addAthleteModal = {
              show: function() {
                $('#addAthleteModal').modal('show');
              },
              hide: function() {
                $('#addAthleteModal').modal('hide');
              }
            };
            console.log('‚úÖ jQuery fallback initialized');
          }
        }
      } else {
        console.error('‚ùå #addAthleteModal element not found in DOM!');
      }

      var btnAddAthlete = document.getElementById('btnAddAthlete');
      var athSport = document.getElementById('ath_sport_id');
      var athName = document.getElementById('ath_name');
      var saveAthBtn = document.getElementById('btnSaveAthlete');
      var athErrBox = document.getElementById('athErr');
      var athOkBox = document.getElementById('athOk');

      function syncAthleteSport() {
        if (!athSport || !sportSelect) return;
        athSport.value = sportSelect.value || '';
      }

      if (sportSelect) sportSelect.addEventListener('change', syncAthleteSport);

      if (btnAddAthlete) {
        btnAddAthlete.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('üü¢ btnAddAthlete clicked');

          syncAthleteSport();
          
          if (!sportSelect || !sportSelect.value) {
            alert('Pilih Cabang Olahraga dulu sebelum tambah pemain.');
            return;
          }

          if (addAthleteModal) {
            console.log('‚úÖ Showing athlete modal');
            addAthleteModal.show();
          } else {
            console.error('‚ùå Modal not initialized. Trying manual show...');
            
            // Fallback manual
            if (addAthleteModalEl) {
              addAthleteModalEl.classList.add('show');
              addAthleteModalEl.style.display = 'block';
              document.body.classList.add('modal-open');
              
              // Add backdrop
              var backdrop = document.createElement('div');
              backdrop.className = 'modal-backdrop fade show';
              backdrop.id = 'tempBackdrop';
              document.body.appendChild(backdrop);
              
              console.log('‚ö†Ô∏è Modal shown manually (fallback)');
            } else {
              alert('Modal tidak tersedia. Coba refresh halaman.');
            }
          }

          setTimeout(function() {
            if (athName) athName.focus();
          }, 200);
        });
      } else {
        console.error('‚ùå btnAddAthlete not found in DOM!');
      }

      // Close button handler untuk fallback manual
      if (addAthleteModalEl) {
        var closeBtn = addAthleteModalEl.querySelector('.btn-close');
        var cancelBtn = addAthleteModalEl.querySelector('.btn-secondary');
        
        function closeModalManual() {
          if (addAthleteModal && addAthleteModal.hide) {
            addAthleteModal.hide();
          } else {
            addAthleteModalEl.classList.remove('show');
            addAthleteModalEl.style.display = 'none';
            document.body.classList.remove('modal-open');
            var backdrop = document.getElementById('tempBackdrop');
            if (backdrop) backdrop.remove();
          }
        }
        
        if (closeBtn) closeBtn.addEventListener('click', closeModalManual);
        if (cancelBtn) cancelBtn.addEventListener('click', closeModalManual);
      }

      function showAthError(msg) {
        if (!athErrBox) return;
        athErrBox.textContent = msg;
        athErrBox.classList.remove('d-none');
        if (athOkBox) athOkBox.classList.add('d-none');
      }

      function showAthOk(msg) {
        if (!athOkBox) return;
        athOkBox.textContent = msg;
        athOkBox.classList.remove('d-none');
        if (athErrBox) athErrBox.classList.add('d-none');
      }

      if (saveAthBtn) {
        saveAthBtn.addEventListener('click', async function() {
          var sport_id = document.getElementById('ath_sport_id') ? document.getElementById('ath_sport_id').value : '';
          var name = document.getElementById('ath_name') ? document.getElementById('ath_name').value : '';
          var number = document.getElementById('ath_number') ? document.getElementById('ath_number').value : '';
          var position = document.getElementById('ath_position') ? document.getElementById('ath_position').value : '';

          name = name.trim();
          if (!sport_id) return showAthError('Pilih cabang olahraga dulu.');
          if (!name) return showAthError('Nama pemain wajib diisi.');

          saveAthBtn.disabled = true;
          saveAthBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Menyimpan...';

          try {
            var resp = await fetch('/subadmin/athletes/ajax-create', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                sport_id: sport_id, 
                name: name, 
                number: number, 
                position: position 
              })
            });

            var data = await resp.json().catch(function() { return {}; });
            if (!resp.ok || !data.ok) {
              return showAthError(data.message || 'Gagal menambahkan pemain.');
            }

            console.log('‚úÖ Athlete created:', data.athlete);

            // Update cache
            window.__ATHLETES__ = Array.isArray(window.__ATHLETES__) ? window.__ATHLETES__ : [];
            
            if (data.athlete) {
              var newAthlete = {
                id: data.athlete.id,
                sport_id: data.athlete.sport_id,
                name: data.athlete.name,
                member_type: data.athlete.member_type || 'individual'
              };
              
              var exists = window.__ATHLETES__.some(function(a) { return a.id === newAthlete.id; });
              if (!exists) {
                window.__ATHLETES__.push(newAthlete);
                console.log('‚úÖ Athlete added to cache:', newAthlete);
                console.log('üìä Total athletes in cache:', window.__ATHLETES__.length);
              }
            }

            // Refresh participant dropdowns with delay
            setTimeout(function() {
              refreshParticipantSelects(false);
              console.log('‚úÖ Participant selects refreshed');
            }, 100);

            showAthOk('Pemain berhasil ditambahkan dan langsung tersedia di dropdown!');
            
            setTimeout(function() {
              if (addAthleteModal) addAthleteModal.hide();
            }, 1000);

            // Clear form
            document.getElementById('ath_name').value = '';
            document.getElementById('ath_number').value = '';
            document.getElementById('ath_position').value = '';

          } catch (e) {
            console.error('‚ùå Error saving athlete:', e);
            showAthError('Server error. Coba lagi.');
          } finally {
            saveAthBtn.disabled = false;
            saveAthBtn.innerHTML = 'Simpan';
          }
        });
      }

      console.log('=== MATCH FORM SCRIPT READY ===');

    })();